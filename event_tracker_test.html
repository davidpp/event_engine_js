<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script src="value_tracker.js"></script>
	<script src="expression_evaluator.js"></script>
	<script src="trigger_tracker.js"></script>
	<script src="event_tracker.js"></script>
	<script>

		function writeMessage(message)
		{
			var messageView = document.getElementById("messageView");

			if (null == messageView)
				return;

			messageView.innerHTML += message;
		}

		var tick = 1000; // 1 tick is 1000 ms
		var value_tracker = new ValueTracker();
		var trigger_tracker = new TriggerTracker(value_tracker);
		var event_tracker = new EventTracker(trigger_tracker);
		var values = new Array();

		// Listeners		
		var value_listener = {
			onValueChanged : function(code, value)
			{
				writeMessage("VALUE CHANGED: " + code + " = " + value + "<br>");

				values[code] = value;
			}
		};

		var trigger_listener = {
			onTriggerFired : function(code)
			{
				writeMessage("TRIGGER FIRED: " + code + "<br>");
			},

			onTriggerReleased : function(code)
			{
				writeMessage("TRIGGER RELEASED: " + code + "<br>");
			}
		};

		var event_listener = {
			onRaised : function(code)
			{
				writeMessage("EVENT RAISED " + code + "<br>");

				if (code == "SPEEDING")
					value_tracker.newValue("speedcount", values["speedcount"] + 1);
			},

			onRepeated : function(code)
			{
				writeMessage("EVENT REPEATED " + code + "<br>");
			},

			onReseted : function(code)
			{
				writeMessage("EVENT RESETED " + code + "<br>");
			}
		};
		
		// Values
		value_tracker.newValue("speed", 0);
		value_tracker.newValue("speedcount", 0);

		value_tracker.addListener("speed", value_listener);
		value_tracker.addListener("speedcount", value_listener);

		// Triggers
		trigger_tracker.addTrigger("EXCESSIVE_SPEEDING", {conditions:"_speedcount==2"});
		trigger_tracker.addTrigger("SPEED_OVER_LEGAL_LIMIT", {conditions:"_speed>110"});
		trigger_tracker.addTrigger("SPEED_BELOW_LEGAL_LIMIT", {conditions:"_speed<=110"});
		trigger_tracker.addTrigger("SPEED_OVER_DRIVE_LIMIT", {conditions:"_speed>30"});
		trigger_tracker.addTrigger("SPEED_BELOW_STOP_LIMIT", {conditions:"_speed<5"});

		trigger_tracker.addListener("EXCESSIVE_SPEEDING", trigger_listener);
		trigger_tracker.addListener("SPEED_OVER_LEGAL_LIMIT", trigger_listener);
		trigger_tracker.addListener("SPEED_BELOW_LEGAL_LIMIT", trigger_listener);
		trigger_tracker.addListener("SPEED_OVER_DRIVE_LIMIT", trigger_listener);
		trigger_tracker.addListener("SPEED_BELOW_STOP_LIMIT", trigger_listener);
		
		// Events
		event_tracker.addEvent("DRIVE", {
			raise_trigger : "SPEED_OVER_DRIVE_LIMIT",
			raise_delay : 5, // 5 ticks

			reset_trigger : "SPEED_BELOW_STOP_LIMIT",
			reset_delay : 10, // 10 ticks

			repeat_interval : 5 // 5 ticks
		});

		event_tracker.addEvent("SPEEDING", {
			raise_trigger : "SPEED_OVER_LEGAL_LIMIT",
			raise_delay : 5, // 5 ticks

			reset_trigger : "SPEED_BELOW_LEGAL_LIMIT",
			reset_delay : 10, // 10 ticks

			repeat_interval : 0
		});

		event_tracker.addListener("DRIVE", event_listener);
		event_tracker.addListener("SPEEDING", event_listener);

		// Once second routine
		window.setInterval(function() {
			event_tracker.tick(event_tracker)
		}, tick);

		// UI Functions
		function setSpeed()
		{
			var speed = parseInt(document.getElementById("speed").value);

			writeMessage("--------------------------------------<br>");
			value_tracker.newValue("speed", speed);
		}

		function clearMessages()
		{
			document.getElementById("messageView").innerHTML = "";
		}

	</script>
</head>
<body>
	<input type="text" id="speed" />
	<button onClick="setSpeed()">Set Speed</button>
	<button onClick="clearMessages()">Clear Messages</button>
	<div id="messageView"></div>
</body>